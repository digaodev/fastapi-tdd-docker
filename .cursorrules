# Cursor AI Rules for fastapi-tdd-docker

## üéØ Core Stack
- Python 3.13 (check `pyproject.toml` for exact version)
- FastAPI + SQLModel (async) + asyncpg + Alembic
- uv for package management
- Tests in `tests/` (root level): `unit_*.py` (mocked) and `integration_*.py` (with DB)
- Docker multi-stage builds for production

## ‚ùå NEVER Do These

1. **Python Version**: Never use versions that don't exist (e.g., 3.14). Always check `pyproject.toml` first.
2. **Test Paths**: Never use old paths like `src/fastapi_tdd_docker/tests/`. Tests are in `tests/` (root).
3. **Module Imports**: Never use hyphens in imports (`fastapi-tdd-docker`). Always use underscores (`fastapi_tdd_docker`).
4. **Docker Commands**: Never use bare `alembic` or `gunicorn`. Always use `python -m alembic` and `python -m gunicorn`.
5. **Database URLs**: Never use sync drivers (`postgresql://`). Always use async (`postgresql+asyncpg://`).
6. **Mocks in Integration Tests**: Never mock database in `integration_*.py` files. Use `client_with_db` fixture.
7. **Import-time Side Effects**: Never call `get_settings()` at module import time in `db.py` or `env.py`.

## ‚úÖ Always Do These

1. **Verify Before Changing**:
   - Check `pyproject.toml` for Python version, dependencies, test paths
   - Check `Makefile` for available commands
   - Check `LLM_ASSISTANT_GUIDE.md` for detailed checklists

2. **Before Committing**:
   ```bash
   make test              # All 36 tests must pass
   make validate          # Linting + type checking
   docker build -f dockerfile.prod -t test .  # Production build must succeed
   ```

3. **File Synchronization**: When changing these, update ALL related files:
   - Python version: `pyproject.toml`, `dockerfile.prod`, `.github/workflows/ci.yml`
   - Test paths: `pyproject.toml` (`testpaths`), `.github/workflows/ci.yml`
   - Package name: Use hyphens for PyPI (`fastapi-tdd-docker`), underscores for imports (`fastapi_tdd_docker`)

4. **Testing Strategy**:
   - Unit tests (`tests/unit_*.py`): Mock everything, no I/O, fast (~0.4s)
   - Integration tests (`tests/integration_*.py`): Real DB, no mocks, slower (~3.3s)
   - Use `@pytest.mark.unit` or `@pytest.mark.integration` markers

## üîß Quick Commands

```bash
make dev               # Start dev server (Docker with hot reload)
make test              # Run all tests
make test-unit         # Run unit tests only (fast, no DB needed)
make test-integration  # Run integration tests (needs DB)
make fix               # Auto-fix linting + formatting
make validate          # Full validation (lint + type + tests)
make migrate-local-create  # Create new migration (prompts for message)
make migrate-local     # Apply migrations locally
```

## üìö Full Documentation

- **Detailed Checklists**: See `LLM_ASSISTANT_GUIDE.md`
- **Development Guide**: See `CLAUDE.md`
- **Contributing**: See `CONTRIBUTING.md`

## üö® If You Make a Mistake

1. Read the full error message and stack trace
2. Check `LLM_ASSISTANT_GUIDE.md` for that specific error
3. Verify file synchronization (Python version, test paths, package names)
4. Test locally before suggesting CI/deployment changes

## üéØ TDD Workflow

1. Write test first (should fail)
2. Implement minimal code to pass test
3. Refactor if needed
4. Run `make validate` before committing
5. All tests must pass before merging

## üìù Notes for Cursor AI

- This project uses strict typing (mypy strict mode)
- All async/await - no sync database operations in production code
- Separate schemas from models (DB models ‚â† API schemas)
- Always use FastAPI dependency injection (`Depends`)
- Database migrations are source of truth (never use `create_all()` in production)
